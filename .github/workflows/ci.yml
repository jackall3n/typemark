name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test (bun ${{ matrix.bun-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        bun-version: [latest, canary]

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ matrix.bun-version }}

      - name: Install dependencies
        run: bun install

      - name: Build packages
        run: bun run build

      - name: Type check
        id: typecheck
        run: bunx tsc --noEmit

      - name: Run tests
        id: tests
        run: bun test packages/typemark/test/ 2>&1 | tee test-output.txt

      - name: Test CLI generate
        run: bun packages/typemark/src/cli.ts generate "examples/*.mdt"

      - name: Type check generated files
        id: typecheck-generated
        run: bunx tsc --noEmit

      - name: Job summary
        if: always()
        run: |
          echo "## CI Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"

          # Type check status
          echo "| Type check | ${{ steps.typecheck.outcome }} |" >> "$GITHUB_STEP_SUMMARY"

          # Test results
          if [ -f test-output.txt ]; then
            PASS_COUNT=$(grep -oE '[0-9]+ pass' test-output.txt | head -1 || true)
            FAIL_COUNT=$(grep -oE '[0-9]+ fail' test-output.txt | head -1 || true)
            TESTS_STATUS="${PASS_COUNT:+$PASS_COUNT}${FAIL_COUNT:+, $FAIL_COUNT}"
            echo "| Tests | ${TESTS_STATUS:-${{ steps.tests.outcome }}} |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| Tests | ${{ steps.tests.outcome }} |" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Generated file type check
          echo "| Type check (generated) | ${{ steps.typecheck-generated.outcome }} |" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**OS:** \`${{ matrix.os }}\` **Bun:** \`${{ matrix.bun-version }}\`" >> "$GITHUB_STEP_SUMMARY"
