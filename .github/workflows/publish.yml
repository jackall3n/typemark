name: Publish

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build packages
        run: bun run build

      - name: Type check
        run: bunx tsc --noEmit

      - name: Run tests
        run: bun test packages/typemark/test/

  publish-typemark:
    name: Publish typemark
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: bun install

      - name: Build
        working-directory: packages/typemark
        run: bun run build

      - name: Publish
        working-directory: packages/typemark
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-loader:
    name: Publish typemark-loader
    needs: [test, publish-typemark]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Install dependencies
        run: bun install

      - name: Build
        working-directory: packages/typemark-loader
        run: bun run build

      - name: Publish
        working-directory: packages/typemark-loader
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-vscode:
    name: Publish typemark-vscode
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Publish
        working-directory: packages/typemark-vscode
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release:
    name: GitHub Release
    needs: [publish-typemark, publish-loader, publish-vscode]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install vsce
        run: bun install -g @vscode/vsce

      - name: Package VS Code extension
        run: |
          TMPDIR=$(mktemp -d)
          cp packages/typemark-vscode/package.json packages/typemark-vscode/language-configuration.json "$TMPDIR/"
          cp -r packages/typemark-vscode/syntaxes packages/typemark-vscode/icons "$TMPDIR/"
          cd "$TMPDIR" && vsce package --allow-missing-repository
          cp "$TMPDIR"/*.vsix "$GITHUB_WORKSPACE/"

      - name: Upload .vsix artifact
        uses: actions/upload-artifact@v4
        with:
          name: typemark-vscode
          path: "*.vsix"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: "*.vsix"
